/*!
 * Justified Gallery - v3.6.3
 * http://miromannino.github.io/Justified-Gallery/
 * Copyright (c) 2016 Miro Mannino
 * Licensed under the MIT license.
 */
(function(t){function i(){return t("body").height()>t(window).height()}var e=function(i,e){this.settings=e;this.checkSettings();this.imgAnalyzerTimeout=null;this.entries=null;this.buildingRow={entriesBuff:[],width:0,height:0,aspectRatio:0};this.lastFetchedEntry=null;this.lastAnalyzedIndex=-1;this.yield={every:2,flushed:0};this.border=e.border>=0?e.border:e.margins;this.maxRowHeight=this.retrieveMaxRowHeight();this.suffixRanges=this.retrieveSuffixRanges();this.offY=this.border;this.rows=0;this.spinner={phase:0,timeSlot:150,$el:t('<div class="spinner"><span></span><span></span><span></span></div>'),intervalId:null};this.checkWidthIntervalId=null;this.galleryWidth=i.width();this.$gallery=i};e.prototype.getSuffix=function(t,i){var e,s;e=t>i?t:i;for(s=0;s<this.suffixRanges.length;s++){if(e<=this.suffixRanges[s]){return this.settings.sizeRangeSuffixes[this.suffixRanges[s]]}}return this.settings.sizeRangeSuffixes[this.suffixRanges[s-1]]};e.prototype.removeSuffix=function(t,i){return t.substring(0,t.length-i.length)};e.prototype.endsWith=function(t,i){return t.indexOf(i,t.length-i.length)!==-1};e.prototype.getUsedSuffix=function(t){for(var i in this.settings.sizeRangeSuffixes){if(this.settings.sizeRangeSuffixes.hasOwnProperty(i)){if(this.settings.sizeRangeSuffixes[i].length===0)continue;if(this.endsWith(t,this.settings.sizeRangeSuffixes[i]))return this.settings.sizeRangeSuffixes[i]}}return""};e.prototype.newSrc=function(t,i,e,s){var n;if(this.settings.thumbnailPath){n=this.settings.thumbnailPath(t,i,e,s)}else{var r=t.match(this.settings.extension);var a=r!==null?r[0]:"";n=t.replace(this.settings.extension,"");n=this.removeSuffix(n,this.getUsedSuffix(n));n+=this.getSuffix(i,e)+a}return n};e.prototype.showImg=function(t,i){if(this.settings.cssAnimation){t.addClass("entry-visible");if(i)i()}else{t.stop().fadeTo(this.settings.imagesAnimationDuration,1,i);t.find("> img, > a > img").stop().fadeTo(this.settings.imagesAnimationDuration,1,i)}};e.prototype.extractImgSrcFromImage=function(t){var i=typeof t.data("safe-src")!=="undefined"?t.data("safe-src"):t.attr("src");t.data("jg.originalSrc",i);return i};e.prototype.imgFromEntry=function(t){var i=t.find("> img");if(i.length===0)i=t.find("> a > img");return i.length===0?null:i};e.prototype.captionFromEntry=function(t){var i=t.find("> .caption");return i.length===0?null:i};e.prototype.displayEntry=function(i,e,s,n,r,a){i.width(n);i.height(a);i.css("top",s);i.css("left",e);var o=this.imgFromEntry(i);if(o!==null){o.css("width",n);o.css("height",r);o.css("margin-left",-n/2);o.css("margin-top",-r/2);var h=o.attr("src");var l=this.newSrc(h,n,r,o[0]);o.one("error",function(){o.attr("src",o.data("jg.originalSrc"))});var g=function(){if(h!==l){o.attr("src",l)}};if(i.data("jg.loaded")==="skipped"){this.onImageEvent(h,t.proxy(function(){this.showImg(i,g);i.data("jg.loaded",true)},this))}else{this.showImg(i,g)}}else{this.showImg(i)}this.displayEntryCaption(i)};e.prototype.displayEntryCaption=function(i){var e=this.imgFromEntry(i);if(e!==null&&this.settings.captions){var s=this.captionFromEntry(i);if(s===null){var n=e.attr("alt");if(!this.isValidCaption(n))n=i.attr("title");if(this.isValidCaption(n)){s=t('<div class="caption">'+n+"</div>");i.append(s);i.data("jg.createdCaption",true)}}if(s!==null){if(!this.settings.cssAnimation)s.stop().fadeTo(0,this.settings.captionSettings.nonVisibleOpacity);this.addCaptionEventsHandlers(i)}}else{this.removeCaptionEventsHandlers(i)}};e.prototype.isValidCaption=function(t){return typeof t!=="undefined"&&t.length>0};e.prototype.onEntryMouseEnterForCaption=function(i){var e=this.captionFromEntry(t(i.currentTarget));if(this.settings.cssAnimation){e.addClass("caption-visible").removeClass("caption-hidden")}else{e.stop().fadeTo(this.settings.captionSettings.animationDuration,this.settings.captionSettings.visibleOpacity)}};e.prototype.onEntryMouseLeaveForCaption=function(i){var e=this.captionFromEntry(t(i.currentTarget));if(this.settings.cssAnimation){e.removeClass("caption-visible").removeClass("caption-hidden")}else{e.stop().fadeTo(this.settings.captionSettings.animationDuration,this.settings.captionSettings.nonVisibleOpacity)}};e.prototype.addCaptionEventsHandlers=function(i){var e=i.data("jg.captionMouseEvents");if(typeof e==="undefined"){e={mouseenter:t.proxy(this.onEntryMouseEnterForCaption,this),mouseleave:t.proxy(this.onEntryMouseLeaveForCaption,this)};i.on("mouseenter",undefined,undefined,e.mouseenter);i.on("mouseleave",undefined,undefined,e.mouseleave);i.data("jg.captionMouseEvents",e)}};e.prototype.removeCaptionEventsHandlers=function(t){var i=t.data("jg.captionMouseEvents");if(typeof i!=="undefined"){t.off("mouseenter",undefined,i.mouseenter);t.off("mouseleave",undefined,i.mouseleave);t.removeData("jg.captionMouseEvents")}};e.prototype.prepareBuildingRow=function(t){var i,e,s,n,r,a=true;var o=0;var h=this.galleryWidth-2*this.border-(this.buildingRow.entriesBuff.length-1)*this.settings.margins;var l=h/this.buildingRow.aspectRatio;var g=this.settings.rowHeight;var f=this.buildingRow.width/h>this.settings.justifyThreshold;if(t&&this.settings.lastRow==="hide"&&!f){for(i=0;i<this.buildingRow.entriesBuff.length;i++){e=this.buildingRow.entriesBuff[i];if(this.settings.cssAnimation)e.removeClass("entry-visible");else{e.stop().fadeTo(0,.1);e.find("> img, > a > img").fadeTo(0,0)}}return-1}if(t&&!f&&this.settings.lastRow!=="justify"&&this.settings.lastRow!=="hide"){a=false;if(this.rows>0){g=(this.offY-this.border-this.settings.margins*this.rows)/this.rows;a=g*this.buildingRow.aspectRatio/h>this.settings.justifyThreshold}}for(i=0;i<this.buildingRow.entriesBuff.length;i++){e=this.buildingRow.entriesBuff[i];s=e.data("jg.width")/e.data("jg.height");if(a){n=i===this.buildingRow.entriesBuff.length-1?h:l*s;r=l}else{n=g*s;r=g}h-=Math.round(n);e.data("jg.jwidth",Math.round(n));e.data("jg.jheight",Math.ceil(r));if(i===0||o>r)o=r}this.buildingRow.height=o;return a};e.prototype.clearBuildingRow=function(){this.buildingRow.entriesBuff=[];this.buildingRow.aspectRatio=0;this.buildingRow.width=0};e.prototype.flushRow=function(t){var i=this.settings;var e,s,n=this.border,r;s=this.prepareBuildingRow(t);if(t&&i.lastRow==="hide"&&s===-1){this.clearBuildingRow();return}if(this.maxRowHeight){if(this.maxRowHeight.isPercentage&&this.maxRowHeight.value*i.rowHeight<this.buildingRow.height){this.buildingRow.height=this.maxRowHeight.value*i.rowHeight}else if(this.maxRowHeight.value>=i.rowHeight&&this.maxRowHeight.value<this.buildingRow.height){this.buildingRow.height=this.maxRowHeight.value}}if(i.lastRow==="center"||i.lastRow==="right"){var a=this.galleryWidth-2*this.border-(this.buildingRow.entriesBuff.length-1)*i.margins;for(r=0;r<this.buildingRow.entriesBuff.length;r++){e=this.buildingRow.entriesBuff[r];a-=e.data("jg.jwidth")}if(i.lastRow==="center")n+=a/2;else if(i.lastRow==="right")n+=a}for(r=0;r<this.buildingRow.entriesBuff.length;r++){e=this.buildingRow.entriesBuff[r];this.displayEntry(e,n,this.offY,e.data("jg.jwidth"),e.data("jg.jheight"),this.buildingRow.height);n+=e.data("jg.jwidth")+i.margins}this.galleryHeightToSet=this.offY+this.buildingRow.height+this.border;this.$gallery.height(this.galleryHeightToSet+this.getSpinnerHeight());if(!t||this.buildingRow.height<=i.rowHeight&&s){this.offY+=this.buildingRow.height+i.margins;this.rows+=1;this.clearBuildingRow();this.$gallery.trigger("jg.rowflush")}};var s=false;e.prototype.checkWidth=function(){this.checkWidthIntervalId=setInterval(t.proxy(function(){var t=parseFloat(this.$gallery.width());if(i()===s){if(Math.abs(t-this.galleryWidth)>this.settings.refreshSensitivity){this.galleryWidth=t;this.rewind();this.startImgAnalyzer(true)}}else{s=i();this.galleryWidth=t}},this),this.settings.refreshTime)};e.prototype.isSpinnerActive=function(){return this.spinner.intervalId!==null};e.prototype.getSpinnerHeight=function(){return this.spinner.$el.innerHeight()};e.prototype.stopLoadingSpinnerAnimation=function(){clearInterval(this.spinner.intervalId);this.spinner.intervalId=null;this.$gallery.height(this.$gallery.height()-this.getSpinnerHeight());this.spinner.$el.detach()};e.prototype.startLoadingSpinnerAnimation=function(){var t=this.spinner;var i=t.$el.find("span");clearInterval(t.intervalId);this.$gallery.append(t.$el);this.$gallery.height(this.offY+this.buildingRow.height+this.getSpinnerHeight());t.intervalId=setInterval(function(){if(t.phase<i.length){i.eq(t.phase).fadeTo(t.timeSlot,1)}else{i.eq(t.phase-i.length).fadeTo(t.timeSlot,0)}t.phase=(t.phase+1)%(i.length*2)},t.timeSlot)};e.prototype.rewind=function(){this.lastFetchedEntry=null;this.lastAnalyzedIndex=-1;this.offY=this.border;this.rows=0;this.clearBuildingRow()};e.prototype.updateEntries=function(i){var e;if(i&&this.lastFetchedEntry!=null){e=t(this.lastFetchedEntry).nextAll(this.settings.selector).toArray()}else{this.entries=[];e=this.$gallery.children(this.settings.selector).toArray()}if(e.length>0){if(t.isFunction(this.settings.sort)){e=this.sortArray(e)}else if(this.settings.randomize){e=this.shuffleArray(e)}this.lastFetchedEntry=e[e.length-1];if(this.settings.filter){e=this.filterArray(e)}else{this.resetFilters(e)}}this.entries=this.entries.concat(e);return true};e.prototype.insertToGallery=function(i){var e=this;t.each(i,function(){t(this).appendTo(e.$gallery)})};e.prototype.shuffleArray=function(t){var i,e,s;for(i=t.length-1;i>0;i--){e=Math.floor(Math.random()*(i+1));s=t[i];t[i]=t[e];t[e]=s}this.insertToGallery(t);return t};e.prototype.sortArray=function(t){t.sort(this.settings.sort);this.insertToGallery(t);return t};e.prototype.resetFilters=function(i){for(var e=0;e<i.length;e++)t(i[e]).removeClass("jg-filtered")};e.prototype.filterArray=function(i){var e=this.settings;if(t.type(e.filter)==="string"){return i.filter(function(i){var s=t(i);if(s.is(e.filter)){s.removeClass("jg-filtered");return true}else{s.addClass("jg-filtered").removeClass("jg-visible");return false}})}else if(t.isFunction(e.filter)){var s=i.filter(e.filter);for(var n=0;n<i.length;n++){if(s.indexOf(i[n])==-1){t(i[n]).addClass("jg-filtered").removeClass("jg-visible")}else{t(i[n]).removeClass("jg-filtered")}}return s}};e.prototype.destroy=function(){clearInterval(this.checkWidthIntervalId);t.each(this.entries,t.proxy(function(i,e){var s=t(e);s.css("width","");s.css("height","");s.css("top","");s.css("left","");s.data("jg.loaded",undefined);s.removeClass("jg-entry");var n=this.imgFromEntry(s);n.css("width","");n.css("height","");n.css("margin-left","");n.css("margin-top","");n.attr("src",n.data("jg.originalSrc"));n.data("jg.originalSrc",undefined);this.removeCaptionEventsHandlers(s);var r=this.captionFromEntry(s);if(s.data("jg.createdCaption")){s.data("jg.createdCaption",undefined);if(r!==null)r.remove()}else{if(r!==null)r.fadeTo(0,1)}},this));this.$gallery.css("height","");this.$gallery.removeClass("justified-gallery");this.$gallery.data("jg.controller",undefined)};e.prototype.analyzeImages=function(i){for(var e=this.lastAnalyzedIndex+1;e<this.entries.length;e++){var s=t(this.entries[e]);if(s.data("jg.loaded")===true||s.data("jg.loaded")==="skipped"){var n=this.galleryWidth-2*this.border-(this.buildingRow.entriesBuff.length-1)*this.settings.margins;var r=s.data("jg.width")/s.data("jg.height");if(n/(this.buildingRow.aspectRatio+r)<this.settings.rowHeight){this.flushRow(false);if(++this.yield.flushed>=this.yield.every){this.startImgAnalyzer(i);return}}this.buildingRow.entriesBuff.push(s);this.buildingRow.aspectRatio+=r;this.buildingRow.width+=r*this.settings.rowHeight;this.lastAnalyzedIndex=e}else if(s.data("jg.loaded")!=="error"){return}}if(this.buildingRow.entriesBuff.length>0)this.flushRow(true);if(this.isSpinnerActive()){this.stopLoadingSpinnerAnimation()}this.stopImgAnalyzerStarter();this.$gallery.trigger(i?"jg.resize":"jg.complete");this.$gallery.height(this.galleryHeightToSet)};e.prototype.stopImgAnalyzerStarter=function(){this.yield.flushed=0;if(this.imgAnalyzerTimeout!==null)clearTimeout(this.imgAnalyzerTimeout)};e.prototype.startImgAnalyzer=function(t){var i=this;this.stopImgAnalyzerStarter();this.imgAnalyzerTimeout=setTimeout(function(){i.analyzeImages(t)},.001)};e.prototype.onImageEvent=function(i,e,s){if(!e&&!s)return;var n=new Image;var r=t(n);if(e){r.one("load",function(){r.off("load error");e(n)})}if(s){r.one("error",function(){r.off("load error");s(n)})}n.src=i};e.prototype.init=function(){var i=false,e=false,s=this;t.each(this.entries,function(n,r){var a=t(r);var o=s.imgFromEntry(a);a.addClass("jg-entry");if(a.data("jg.loaded")!==true&&a.data("jg.loaded")!=="skipped"){if(s.settings.rel!==null)a.attr("rel",s.settings.rel);if(s.settings.target!==null)a.attr("target",s.settings.target);if(o!==null){var h=s.extractImgSrcFromImage(o);o.attr("src",h);if(s.settings.waitThumbnailsLoad===false){var l=parseFloat(o.attr("width"));var g=parseFloat(o.attr("height"));if(!isNaN(l)&&!isNaN(g)){a.data("jg.width",l);a.data("jg.height",g);a.data("jg.loaded","skipped");e=true;s.startImgAnalyzer(false);return true}}a.data("jg.loaded",false);i=true;if(!s.isSpinnerActive())s.startLoadingSpinnerAnimation();s.onImageEvent(h,function(t){a.data("jg.width",t.width);a.data("jg.height",t.height);a.data("jg.loaded",true);s.startImgAnalyzer(false)},function(){a.data("jg.loaded","error");s.startImgAnalyzer(false)})}else{a.data("jg.loaded",true);a.data("jg.width",a.width()|parseFloat(a.css("width"))|1);a.data("jg.height",a.height()|parseFloat(a.css("height"))|1)}}});if(!i&&!e)this.startImgAnalyzer(false);this.checkWidth()};e.prototype.checkOrConvertNumber=function(i,e){if(t.type(i[e])==="string"){i[e]=parseFloat(i[e])}if(t.type(i[e])==="number"){if(isNaN(i[e]))throw"invalid number for "+e}else{throw e+" must be a number"}};e.prototype.checkSizeRangesSuffixes=function(){if(t.type(this.settings.sizeRangeSuffixes)!=="object"){throw"sizeRangeSuffixes must be defined and must be an object"}var i=[];for(var e in this.settings.sizeRangeSuffixes){if(this.settings.sizeRangeSuffixes.hasOwnProperty(e))i.push(e)}var s={0:""};for(var n=0;n<i.length;n++){if(t.type(i[n])==="string"){try{var r=parseInt(i[n].replace(/^[a-z]+/,""),10);s[r]=this.settings.sizeRangeSuffixes[i[n]]}catch(t){throw"sizeRangeSuffixes keys must contains correct numbers ("+t+")"}}else{s[i[n]]=this.settings.sizeRangeSuffixes[i[n]]}}this.settings.sizeRangeSuffixes=s};e.prototype.retrieveMaxRowHeight=function(){var i={};if(t.type(this.settings.maxRowHeight)==="string"){if(this.settings.maxRowHeight.match(/^[0-9]+%$/)){i.value=parseFloat(this.settings.maxRowHeight.match(/^([0-9]+)%$/)[1])/100;i.isPercentage=false}else{i.value=parseFloat(this.settings.maxRowHeight);i.isPercentage=true}}else if(t.type(this.settings.maxRowHeight)==="number"){i.value=this.settings.maxRowHeight;i.isPercentage=false}else if(this.settings.maxRowHeight===false||this.settings.maxRowHeight===null||typeof this.settings.maxRowHeight=="undefined"){return null}else{throw"maxRowHeight must be a number or a percentage"}if(isNaN(i.value))throw"invalid number for maxRowHeight";if(i.isPercentage){if(i.value<100)i.value=100}return i};e.prototype.checkSettings=function(){this.checkSizeRangesSuffixes();this.checkOrConvertNumber(this.settings,"rowHeight");this.checkOrConvertNumber(this.settings,"margins");this.checkOrConvertNumber(this.settings,"border");var i=["justify","nojustify","left","center","right","hide"];if(i.indexOf(this.settings.lastRow)===-1){throw"lastRow must be one of: "+i.join(", ")}this.checkOrConvertNumber(this.settings,"justifyThreshold");if(this.settings.justifyThreshold<0||this.settings.justifyThreshold>1){throw"justifyThreshold must be in the interval [0,1]"}if(t.type(this.settings.cssAnimation)!=="boolean"){throw"cssAnimation must be a boolean"}if(t.type(this.settings.captions)!=="boolean")throw"captions must be a boolean";this.checkOrConvertNumber(this.settings.captionSettings,"animationDuration");this.checkOrConvertNumber(this.settings.captionSettings,"visibleOpacity");if(this.settings.captionSettings.visibleOpacity<0||this.settings.captionSettings.visibleOpacity>1){throw"captionSettings.visibleOpacity must be in the interval [0, 1]"}this.checkOrConvertNumber(this.settings.captionSettings,"nonVisibleOpacity");if(this.settings.captionSettings.nonVisibleOpacity<0||this.settings.captionSettings.nonVisibleOpacity>1){throw"captionSettings.nonVisibleOpacity must be in the interval [0, 1]"}this.checkOrConvertNumber(this.settings,"imagesAnimationDuration");this.checkOrConvertNumber(this.settings,"refreshTime");this.checkOrConvertNumber(this.settings,"refreshSensitivity");if(t.type(this.settings.randomize)!=="boolean")throw"randomize must be a boolean";if(t.type(this.settings.selector)!=="string")throw"selector must be a string";if(this.settings.sort!==false&&!t.isFunction(this.settings.sort)){throw"sort must be false or a comparison function"}if(this.settings.filter!==false&&!t.isFunction(this.settings.filter)&&t.type(this.settings.filter)!=="string"){throw"filter must be false, a string or a filter function"}};e.prototype.retrieveSuffixRanges=function(){var t=[];for(var i in this.settings.sizeRangeSuffixes){if(this.settings.sizeRangeSuffixes.hasOwnProperty(i))t.push(parseInt(i,10))}t.sort(function(t,i){return t>i?1:t<i?-1:0});return t};e.prototype.updateSettings=function(i){this.settings=t.extend({},this.settings,i);this.checkSettings();this.border=this.settings.border>=0?this.settings.border:this.settings.margins;this.maxRowHeight=this.retrieveMaxRowHeight();this.suffixRanges=this.retrieveSuffixRanges()};t.fn.justifiedGallery=function(i){return this.each(function(s,n){var r=t(n);r.addClass("justified-gallery");var a=r.data("jg.controller");if(typeof a==="undefined"){if(typeof i!=="undefined"&&i!==null&&t.type(i)!=="object"){if(i==="destroy")return;throw"The argument must be an object"}a=new e(r,t.extend({},t.fn.justifiedGallery.defaults,i));r.data("jg.controller",a)}else if(i==="norewind"){}else if(i==="destroy"){a.destroy();return}else{a.updateSettings(i);a.rewind()}if(!a.updateEntries(i==="norewind"))return;a.init()})};t.fn.justifiedGallery.defaults={sizeRangeSuffixes:{},thumbnailPath:undefined,rowHeight:120,maxRowHeight:false,margins:1,border:-1,lastRow:"nojustify",justifyThreshold:.9,waitThumbnailsLoad:true,captions:true,cssAnimation:true,imagesAnimationDuration:500,captionSettings:{animationDuration:500,visibleOpacity:.7,nonVisibleOpacity:0},rel:null,target:null,extension:/\.[^.\\/]+$/,refreshTime:200,refreshSensitivity:0,randomize:false,sort:false,filter:false,selector:"a, div:not(.spinner)"}})(jQuery);